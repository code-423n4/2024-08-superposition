package erc20

import (
	"encoding/hex"
	"math/big"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestDecodeErc20Details(t *testing.T) {
	//cast call 0xcA11bde05977b3631167028862bE2a173976CA11 'aggregate((address,bytes)[])' ['('0x000F1720A263f96532D1ac2bb9CDC12b72C6f386,`{cast calldata 'name()'}')','('0x000F1720A263f96532D1ac2bb9CDC12b72C6f386,`{cast calldata 'symbol()'}')','('0x000F1720A263f96532D1ac2bb9CDC12b72C6f386,`{cast calldata 'totalSupply()'}')','('0x000F1720A263f96532D1ac2bb9CDC12b72C6f386,`{cast calldata 'decimals()'}')']
	rd, err := hex.DecodeString(`00000000000000000000000000000000000000000000000000000000012d7cd50000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000008466c756964697479000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003464c590000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000038d7ea4c6800000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000006`)
	if err != nil {
		t.Fatalf("unable to decode test: %v", err)
	}
	i, err := multicallAbi.Unpack("aggregate", rd)
	if err != nil {
		t.Fatalf("failed to unpack aggregate: %v", err)
	}
	t.Logf("multicall unpack data: %v", i)
	name, symbol, totalSupply, err := decodeErc20Details(i[1])
	if err != nil {
		t.Fatalf("failed to unpack erc20 decimals: %v", err)
	}
	assert.Equal(t, "Fluidity", name)
	assert.Equal(t, "FLY", symbol)
	assert.Equal(t, new(big.Int).SetInt64(1000000000000000), totalSupply.Int)
}
